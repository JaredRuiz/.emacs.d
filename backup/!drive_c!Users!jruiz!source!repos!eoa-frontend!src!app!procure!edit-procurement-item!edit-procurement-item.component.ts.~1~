import { Component, OnInit, Input, Output, EventEmitter, ViewChild } from '@angular/core';
import { EquipmentViewModel } from '@app/order/shared/viewmodels/equipment-viewmodel';
import { SplitEquipmenViewModel } from '@app/order/shared/viewmodels/split-equipment-viewmodel';
import { FormGroup, FormArray, FormControl, NgForm } from '@angular/forms';
declare var $: any;

@Component({
  selector: 'app-edit-equipment-item',
  templateUrl: './edit-equipment-item.component.html'
})
export class EditEquipmentItemComponent implements OnInit {

  @ViewChild('editEquipmentForm') editEquipmentForm: NgForm;
  _equipmentItemSelectedToEdit = new EquipmentViewModel();
  @Input() set equipmentItemSelectedToEdit(value: EquipmentViewModel) {
    this._equipmentItemSelectedToEdit = value;
    this.orginialEquipmentItemSelectedToEdit = $.extend(true, {}, value);
    this.selectedEquipmentItemOriginalQuantity = value.currentTotalQuantity;
  }
  get equipmentItemSelectedToEdit() {
    return this._equipmentItemSelectedToEdit;
  }

  selectedEquipmentItemOriginalQuantity = 0;
  orginialEquipmentItemSelectedToEdit: EquipmentViewModel;
  displaySplitQuantity = false;
  addAlternateDeliveryLocation = false;
  splitEquipmentItem: SplitEquipmenViewModel;
  isSelectedCurrentDeliveryDateValid = true;
  disableSplitButton = false;

  @Output() cancelEquipmentItemEditTriggered = new EventEmitter();
  @Output() saveEquipmentItemUpdatesTriggered = new EventEmitter<any>();

  private static markAsTouched(group: FormGroup | FormArray) {
    Object.keys(group.controls).map((field) => {
      const control = group.get(field);
      if (control instanceof FormControl) {
        control.markAsTouched({ onlySelf: true });
      } else if (control instanceof FormGroup) {
        this.markAsTouched(control);
      }
    });
  }

  constructor() { }

  ngOnInit() {
  }

  onCurrentDeliveryDatePickerBackspaceKeyPressed() {
    this.isSelectedCurrentDeliveryDateValid = this.editEquipmentForm.submitted;
  }

  onSplitQuantityButtonClicked() {
    if (this.equipmentItemSelectedToEdit.currentTotalQuantity > 1) {
      this.displaySplitQuantity = true;
      this.splitEquipmentItem = <SplitEquipmenViewModel>{
        splitItemRevisionBulletinNo: this.equipmentItemSelectedToEdit.revisionBulletinNo,
        splitItemDeliveryDate: this.orginialEquipmentItemSelectedToEdit.deliveryDate,
        splitQuantity: 1,
        alternateDeliveryLocation: ''
      };
      this.equipmentItemSelectedToEdit.currentTotalQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity - 1;
    }
  }

  onOriginalQuantityChangeClicked(isIncrement) {
    if (!this.displaySplitQuantity) {
      return;
    }
    if (isIncrement) {
      if (this.equipmentItemSelectedToEdit.currentTotalQuantity < this.selectedEquipmentItemOriginalQuantity - 1) {
        this.equipmentItemSelectedToEdit.currentTotalQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity + 1;
        this.splitEquipmentItem.splitQuantity = this.splitEquipmentItem.splitQuantity - 1;
      }
    } else {
      if (this.equipmentItemSelectedToEdit.currentTotalQuantity > 1) {
        this.equipmentItemSelectedToEdit.currentTotalQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity - 1;
        this.splitEquipmentItem.splitQuantity = this.splitEquipmentItem.splitQuantity + 1;
      }
    }
  }

  onSplitEquipmentItemQuantityChangeClicked(isIncrement) {
    if (isIncrement) {
      if (this.equipmentItemSelectedToEdit.currentTotalQuantity > 1) {
        this.equipmentItemSelectedToEdit.currentTotalQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity - 1;
        this.splitEquipmentItem.splitQuantity = this.splitEquipmentItem.splitQuantity + 1;
      }
    } else {
      if (this.splitEquipmentItem.splitQuantity > 1) {
        this.equipmentItemSelectedToEdit.currentTotalQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity + 1;
        this.splitEquipmentItem.splitQuantity = this.splitEquipmentItem.splitQuantity - 1;
      }
    }
  }

  onEquipmentItemDeliveryDateSelectionTriggered(selectedDeliveryDate) {
    this.equipmentItemSelectedToEdit.deliveryDate = selectedDeliveryDate;
  }

  onSplitEquipmentItemDeliveryDateSelectionTriggered(selectedDeliveryDate) {
    this.splitEquipmentItem.splitItemDeliveryDate = selectedDeliveryDate;
  }

  onSaveEquipmentItemUpdatesClicked() {
    EditEquipmentItemComponent.markAsTouched(this.editEquipmentForm.form);
    if (this.editEquipmentForm.valid && this.displaySplitQuantity && this.splitEquipmentItem.splitQuantity > 0) {
      this.splitEquipmentItem.remainderQuantity = this.equipmentItemSelectedToEdit.currentTotalQuantity;
      this.splitEquipmentItem.editItemdeliveryDate = this.equipmentItemSelectedToEdit.deliveryDate;
      this.splitEquipmentItem.editItemRevisionBulletinNo = this.equipmentItemSelectedToEdit.revisionBulletinNo;
      this.saveEquipmentItemUpdatesTriggered.emit(
        { editEquimentItem: this.equipmentItemSelectedToEdit, splitEquipmentItem: this.splitEquipmentItem }
      );
      this.reset();
    } else if (this.editEquipmentForm.valid && !this.displaySplitQuantity) {
      this.saveEquipmentItemUpdatesTriggered.emit(
        { editEquimentItem: this.equipmentItemSelectedToEdit }
      );
      this.reset();
    }
  }

  onCancelEquipmentItemUpdatesClicked() {
    this.equipmentItemSelectedToEdit.deliveryDate = this.orginialEquipmentItemSelectedToEdit.deliveryDate;
    this.equipmentItemSelectedToEdit.revisionBulletinNo = this.orginialEquipmentItemSelectedToEdit.revisionBulletinNo;
    this.equipmentItemSelectedToEdit.currentTotalQuantity = this.orginialEquipmentItemSelectedToEdit.currentTotalQuantity;
    this.reset();
    this.cancelEquipmentItemEditTriggered.emit();
  }

  onHideSplitQuantityCardClicked() {
    this.displaySplitQuantity = false;
    this.splitEquipmentItem = null;
    this.equipmentItemSelectedToEdit.currentTotalQuantity = this.orginialEquipmentItemSelectedToEdit.currentTotalQuantity;
  }

  private reset() {
    this.displaySplitQuantity = false;
    this.splitEquipmentItem = null;
    this.addAlternateDeliveryLocation = false;
    this.selectedEquipmentItemOriginalQuantity = 0;
    this.disableSplitButton = false;
  }
}
