import { Component, OnInit, ViewChild, OnDestroy } from '@angular/core';
import { ReportService } from '@app/report/shared/report.service';
import { ProjectDropdownViewModel } from '@app/report/shared/viewmodels/project-dropdown-viewmodel';
import { NgSelectComponent } from '@ng-select/ng-select';
import { Subscription } from 'rxjs';
import { ProjectSpreadsheetViewModel } from '@app/report/shared/viewmodels/project-spreadsheet-viewmodel';
//import { HttpErrorResponse } from '@angular/common/http'

@Component({
  selector: 'app-drawing-count',
  templateUrl: './drawing-count.component.html',
  styleUrls: ['./drawing-count.component.scss']
})
export class DrawingCountComponent implements OnInit, OnDestroy {
  @ViewChild('projectListDropdown') projectListDropdown: NgSelectComponent;

  subscription$: Subscription;
  projectListItems: Array<ProjectDropdownViewModel>;
  selectedProject: ProjectDropdownViewModel;
  drawingCount: ProjectSpreadsheetViewModel; // TODO: this name may be dumb..

  constructor(
    private reportService: ReportService
    ) {}

  ngOnInit() {
    this.loadProjects();
  }

  ngOnDestroy(): void {
    // TODO: we may not have to do this...
    // this.subscription$.unsubscribe();
  }

  onSelectedProjectListItemChanged() {
    if (this.selectedProject) {
      this.reportService.getDrawingCountForProject(this.selectedProject.id)
      .subscribe(projectCountDetails => {
        this.drawingCount = projectCountDetails;
        console.log('are we getting here');
        console.log(this.drawingCount);
      });
    }
  }

  private loadProjects() {
    this.reportService.getProjects().subscribe(projects => {
      this.projectListItems = projects;
      setTimeout(() => {
        if (this.projectListItems && this.projectListItems.length > 0) {
          this.selectedProject = this.projectListItems[0];
          this.onSelectedProjectListItemChanged();
        }
      }, 0);
    });
  }
}
